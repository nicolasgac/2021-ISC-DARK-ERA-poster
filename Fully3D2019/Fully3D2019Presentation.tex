%Bayesian_tools.tex
%
\documentclass[latex]{beamer}
\usepackage{graphicx,xspace,color}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[francais]{babel}
\usepackage{subfig}
\usepackage[french,linesnumbered,algoruled]{algorithm2e}
\usepackage{algorithmic}
\usepackage{multirow}
\usepackage{pstricks}
\usepackage{pst-grad} % For gradients
\usepackage{pst-plot} % For axes
\usepackage{epsfig}
\usepackage[babel=true]{csquotes}
\usepackage{float}
\usepackage{multirow}
\usepackage{epstopdf}
\epstopdfsetup{suffix=}
\setbeamertemplate{bibliography item}[text]
\setbeamercolor*{bibliography entry author}{fg=black}
\setbeamercolor*{bibliography item}{fg=black}

\graphicspath{{figuresFully3D2017/}}
\mode<presentation>
{
  \usetheme{default}
  \setbeamercovered{transparent}
}
%------------------MACROS -----------------------
%\def\inputdir{/home/djafari/2015/Inputs/}
\input{alphabet1}
\input{alphabet2}
\input{macros_gpi}
\input{macros1}
\input{macros2}
\input{macros3}
\input{macros_WANG}
%\input{\inputdir dessins_all}
% pour les slides
\def\beq{\[} \def\eeq{\]}

%-------------------------------------------------
\title{Joint Reconstruction and Segmentation of Real 3D Data in Computed Tomography thanks to a Gauss-Markov-Potts Prior Model \\Fully 3D - 2017/06/18}

\author{Camille Chapdelaine$^{1,2}$, Ali Mohammad-Djafari$^1$, Nicolas Gac$^1$ and Estelle Parra$^2$ \\ 
\footnotesize $^1$
  Laboratoire des signaux et systèmes, CNRS, Centralesupélec-Univ Paris Saclay, Gif-sur-Yvette, France\\   
  \footnotesize $^2$
  SAFRAN SA, Safran Tech, P\^ole Technologie du Signal et de l'Information, Magny-Les-Hameaux, France.
}
\subject{}
\date{}


\setbeamertemplate{footline}[text line]{\hspace{-8mm} C. Chapdelaine, A. Mohammad-Djafari, N. Gac, E. Parra \; Fully 3D 2017. \insertframenumber/\inserttotalframenumber}
%\setbeamertemplate{footline}[page number]
\setbeamertemplate{section in toc}[sections numbered]


\SetAlFnt{\tiny\sffamily}

\AtBeginSection[]
{
  \begin{frame}
  \frametitle{Sommaire}
  \tableofcontents[currentsection,hideothersubsections,subsectionstyle=show/shaded,subsubsectionstyle=show/shaded]
  \end{frame} 
}

\AtBeginSubsection[]
{
  \begin{frame}
  \frametitle{Sommaire}
  \tableofcontents[currentsubsection,hideothersubsections,subsubsectionstyle=show/shaded,subsectionstyle=show/shaded,sectionstyle=show/shaded]
  \end{frame} 
}

\AtBeginSubsubsection[]
{
  \begin{frame}
  \frametitle{Sommaire}
  \tableofcontents[currentsubsubsection,hideothersubsubsections,subsectionstyle=show/shaded,sectionstyle=show/shaded,subsubsectionstyle=show/shaded]
  \end{frame} 
}

\setbeamercolor{block title}{bg=cyan,fg=white}

% Plan :
%Problématique : contexte : reconstruction d'un volume constitué de plusieurs matériaux : un matériau=une classe : classes quasi-homogènes et compactes
%Motivations : réglage automatique des hyperparamètres en construisant le terme de régularisation à l'aide d'une segmentation estimée conjointement avec le volume
%Modèles a priori : projections, Gauss-Markov-Potts : loi de Potts : une slide, avec l'influence du paramètre gamma0
%Structure de l'algorithme : schéma : construction du terme de régularisation
%Stratégies pour fixer les paramètres : semi-automatique
%Indicateurs de qualité
%Comparaison des résultats : profils des trous
%Conclusion : avantages : facilement parallélisable, reconstruction et segmentation en même temps, amélioration de l'homogénéité, centrer les valeurs autour de la moyenne, fort contraste
%Perspectives : segmentation sur GPU (75 pourcents du temps sur CPU), paire duale, réglage du paramètre de Potts

\begin{document}
%---------------------------------------------------------------
\begin{frame}{} 
\bcc
\vspace*{-5mm}\begin{tabular}{cc}
\includegraphics[height=0.15\textheight]{logosafran} 
\hspace{0.15\textwidth} { }& 
\includegraphics[height=0.12\textheight]{logol2s} 
\end{tabular}
\\[18pt]
\blue{\Large
Joint Reconstruction and Segmentation of Real 3D Data in Computed Tomography thanks to a Gauss-Markov-Potts Prior Model \\~\\Fully 3D - 2017/06/18
} \\~\\
\blue{\large Camille Chapdelaine$^{1,2}$, Ali Mohammad-Djafari$^1$, Nicolas Gac$^1$ and Estelle Parra$^2$.} \\~\\  
\footnotesize $^1$
  Laboratoire des signaux et systèmes, CNRS, Centralesupélec-Univ Paris Saclay, Gif-sur-Yvette, France\\   
  \footnotesize $^2$
  SAFRAN SA, Safran Tech, P\^ole Technologie du Signal et de l'Information, Magny-Les-Hameaux, France
\ecc
%\maketitle
\end{frame}

\begin{frame}{}
\begin{block}{Context}
\begin{enumerate}
\item We focus on the reconstruction of industrial parts for non-destructive testing (NDT)
\item The volumes to reconstruct are composed of several materials
\item Each material forms one or several regions which can be described as compact and quasi-homogeneous
\item We are eager to jointly reconstruct the volume and to obtain labels corresponding to the materials to which each voxel belongs : this leads to perform a joint reconstruction and segmentation of the volume.
\item The increase of the use of GPU for high-performance computing makes affordable to consider Markovian models in order to increase the quality of the reconstruction.
\item We propose a fast and highly-parallelizable algorithm in order to jointly reconstruct and label huge 3D volumes.
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{}
\begin{block}{Motivations}
\begin{enumerate}
\item Computed Tomography (CT) reconstruction problem is an ill-posed problem, which needs a regularization
\item In practice, the hyperparameters representing the tradeoff between the data-matching and the regularization terms are not easy to tune
\item The (semi-automatic) proposed method jointly estimate the optimal  hyperparameters for a regularization based on the segmentation of the volume to reconstruct
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Prior Models}
\begin{block}{Forward model}
\bfig[h]
\centering
\includegraphics[scale=0.4]{ConeBeamAcquisitionProcess}
\caption*{Cone-beam acquisition process}
\label{fig : Processus d'acquisition des projections}
\efig
The forward model accounting for the noise is
\beq
\bgb=\Hb\rfb+\red{\epsilonb}, \mbox{~~~~} \red{\epsilon_i} \sim \Nc(0, \red{v_{\epsilon_i}}), \forall i \in \left\{1, \dots, M\right\}
\eeq
\end{block}
\end{frame}

\begin{frame}{Prior Models}
\begin{block}{Forward model}
\begin{enumerate}
\item The uncertainties $\red{\vb_{\epsilon}}$ weight the data :
\begin{align*}
p(\bgb|\rfb, \red{\vb_{\epsilon}})&\propto\expf{-\frac{1}{2}\|\bgb-\Hb\rfb\|_{\red{\Vb_{\epsilon}}}^2} \\
&\propto \expf{-\frac{1}{2} \sum_{i=1}^{M} \frac{1}{\red{v_{\epsilon_{i}}}}\left(\blue{g_{i}}-\left[\Hb\rfb\right]_{i}\right)^{2}}
\end{align*}
with $\red{\Vb_{\epsilon}}=\diag{\red{\vb_{\epsilon}}}$
\item Optimal $\red{\vb_{\epsilon}}$ are unknown
\item Conjugate prior on $\red{v_{\epsilon_i}}$
\beq
\red{v_{\epsilon_i}} \sim \Ic\Gc(\alpha_{\epsilon_0}, \beta_{\epsilon_0}), \forall i \in \left\{1, \dots, M\right\}
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Prior models}
\begin{block}{Prior on the volume : Gauss-Markov-Potts prior model}
\begin{enumerate}
\item Label each voxel $j$ depending on the material to which the voxel belongs : $\red{z_{j}}=k$ if voxel $j$ composes material $k$, $k \in \left\{1, \dots, K\right\}$
\item $K$ : number of materials in the volume
\item The distribution of $\red{f_j}$ depends on the label of voxel $j$ :
\beq
\red{f_j} \sim \Nc(\red{m_k}, \red{v_k}) \mbox{~~if~~} \red{z_j}=k.
\eeq
\item Priors for the means $\red{\mb}$ and the variances $\red{\vb}$ are
\beq
\red{m_k} \sim \Nc(m_0, v_0), \forall k \in \left\{1, \dots, K\right\}
\eeq
and
\beq
\red{v_k} \sim \Ic\Gc(\alpha_0, \beta_0), \forall k \in \left\{1, \dots, K\right\}
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Prior models}
\begin{block}{Prior on the labels}
\begin{enumerate}
\item The hidden variables $\red{\zb}$ is modeled as a Potts field 
\beq
\small
p(\rzb|\gamma_0, \alphab)\propto\exp{\left[\sum_{j=1}^{N} \left(\sum_{k=1}^{K} \alpha_k \delta(\red{z_j}-k)+\gamma_0 \sum_{i\in\Vc(j)}\delta(\red{z_j}-\red{z_i})\right)\right]}
\eeq
\item Potts coefficient $\gamma_0$ fits the compacity of the regions
\begin{figure}
 \begin{minipage}[htb]{0.24\linewidth}
  \centering
  \includegraphics[scale=1.5]{LabelsGamma0point5K5}
  \caption*{$\gamma_0=0.5$}
 \end{minipage} \hfill
 \begin{minipage}[htb]{0.24\linewidth}
  \centering
  \includegraphics[scale=1.5]{LabelsGamma0point7K5}
  \caption*{$\gamma_0=0.7$}
 \end{minipage} \hfill
 \begin{minipage}[htb]{0.24\linewidth}
  \centering
  \includegraphics[scale=1.5]{LabelsGamma0point8K5}
  \caption*{$\gamma_0=0.8$}
 \end{minipage} \hfill
 \begin{minipage}[htb]{0.24\linewidth}
  \centering
  \includegraphics[scale=1.5]{LabelsGamma1point6K5}
  \caption*{$\gamma_0=1.6$}
 \end{minipage} 
 \caption{Potts field for different values of $\gamma_0$}
 \label{fig:Potts field for different values of gamma_0}
\end{figure}
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Prior Models}
\begin{block}{Hierarchical Model}
\bfig[htb]
\bcc
\begin{picture}(60,150)
  \put(-15,115){\framebox(20,15){$K$}}
  \put(-5,115){\line(0,-1){45}}
  \put(-5, 70){\vector(-1, 0){25}}

  \put(-50,115){\framebox(20,15){$\gamma_0$}}
  \put(-40,115){\vector(0,-1){35}}
  
  \put(-85,115){\framebox(20,15){$\alphab$}}
  \put(-75,115){\line(0,-1){45}}
  \put(-75, 70){\vector(1, 0){25}}

  \put(-40,70){\makebox(0,0){$\rzb$}}
  \put(-40,70){\circle{20}}
  \put(-40, 60){\line(0, -1){20}}
  \put(-40, 40){\vector(1, 0){60}}

  \put(12.5,115){\framebox(30,15){$m_0,v_0$}}
  \put(30,115){\vector(0,-1){35}}
  \put(30,70){\circle{20}}
  \put(30,70){\makebox(0,0){$\rmb$}}
  \put(30,60){\vector(0,-1){10}}
  
  \put(48,115){\framebox(30,15){$\alpha_0,\beta_0$}}
  \put(65,115){\vector(0,-1){35}}
  \put(65,70){\makebox(0,0){$\rvb$}}
  \put(65,70){\circle{20}}
  \put(65,60){\line(0,-1){20}}
  \put(65,40){\vector(-1,0){25}}
  
  \put(83.5,115){\framebox(34,15){$\alphaez,\betaez$}}
  \put(100.5,115){\vector(0,-1){35}}
  \put(100.5,70){\makebox(0,0){$\red{\vb_{\epsilon}}$}}
  \put(100.5,70){\circle{20}}

  \put(30,40){\makebox(0,0){$\rfb$}}
  \put(30,40){\circle{20}}

  \put(100.5,60){\line(0,-1){60}}
  \put(100.5,0){\vector(-1,0){60.5}}
  
  \put(30,30){\vector(0,-1){20}}
  \put(25,20){\makebox(0,0){$\Hb$}}
  \put(30,0){\circle{20}}
  \put(30,0){\makebox(0,0){$\bgb$}}
   
 \end{picture}
\ecc
\efig
\end{block}
\end{frame}

\begin{frame}{Joint Maximization a Posteriori (JMAP)}
\begin{block}{Use of Bayes rule}
\begin{enumerate}
\item Estimate the unknowns $\fb, \zb, \vb_{\epsilon}, \mb$ and $\vb$ by maximizing their joint posterior probability
\beq
(\hat{\rfb},\hat{\rzb},\hat{\rvb}_{\red{\epsilon}},\hat{\rmb},\hat{\rvb})=
\argmax{(\rfb,\rzb,\red{\vb_{\epsilon}},\rmb,\rvb)}{p(\rfb,\rzb,\red{\vb_{\epsilon}},\rmb,\rvb|\bgb;\Mc)}
\eeq
\item An alternate optimization scheme is found by applying Bayes rule
\beq
\barr{ll}
p(\rfb,\rzb,\red{\vb_{\epsilon}},\rmb,\rvb|\bgb;\Mc)&\propto 
p(\bgb|\rfb,\red{\vb_{\epsilon}})\, p(\rfb|\rzb,\rmb,\rvb) \, \\ 
&p(\red{\vb_{\epsilon}}|\alphaez,\betaez)\, 
p(\rzb|\alphab; \gamma_0) \, \\
&p(\rmb|m_{0}, v_{0})\, p(\rvb|\alpha_0, \beta_0), 
\earr
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Joint Maximization a Posteriori (JMAP)}
% The iterative update of each unknown yields a criterion for estimating the volume. Each hyperparameters of the criterion are optimal for the controlled volume thanks to the joint estimation
\begin{block}{Alternate optimization}
\bfig[htb]
\bcc
\begin{picture}(200,150)
  \put(40,140){\framebox(180,20){1 : update volume \red{\fb} (minimize $J(\rfb)$)}}
  \put(130,140){\line(0,-1){10}}
  \put(130,130){\line(-1,0){85}}
  \put(45,130){\vector(0,-1){10}}
  \put(-20,100){\framebox(130,20){2 : update uncertainties $\red{\vb_{\epsilon}}$}}
  \put(45,100){\vector(0,-1){100}}
  \put(130,130){\line(1,0){65}}
  \put(195,130){\vector(0,-1){10}}
  \put(150,100){\framebox(90,20){3 : update labels $\red{\zb}$}}
  \put(195,100){\vector(0,-1){20}}
  \put(145,60){\framebox(100,20){4 : update means $\red{\mb}$}}
  \put(195,60){\vector(0,-1){20}}
  \put(140,20){\framebox(110,20){5 : update variances $\red{\vb}$}}
  \put(195,20){\vector(0,-1){20}}
  
  
  \put(-10,-20){\makebox(0,0){$J(\rfb)=$}}
  \put(55,-20){\makebox(0,0){$\|\bgb-\Hb\rfb\|_{\red{\Vb_{\epsilon}}}^{2}$}}
  \put(120,-20){\makebox(0,0){$+$}}
  \put(205,-20){\makebox(0,0){$\|\rfb-\rmb_{\rzb}\|_{\red{\Vb_{\zb}}}^{2}$}}
  \put(-30,-20){\line(-1,0){20}}
  \put(-50,-20){\line(0,1){170}}
  \put(-50,150){\vector(1,0){90}}
   
\end{picture}
\ecc
\efig
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Data}
\begin{enumerate}
\item Test on patented real IQI (Image Quality Indicator) \cite{gay2016fantomeiqi} with $512 \times 512 \times 256$ voxels
\item $300$ projections are used, with $512 \times 256$ pixels
\item $K=4$ materials
%% volume original
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.25]{volume_FDK2400projBas.png}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.25]{volume_FDK2400projHaut.png}
\end{minipage}
\caption*{Real IQI phantom (bottom and top) (retrieved from avec 2400 projections)}
\label{fig:Real IQI data}
\end{figure}
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Strategies to fix the parameters}
\begin{enumerate}
\item Prior on the volume : use of a first estimate $\rfb^{(0)}$ (FDK) :
\beq
m_{0}=\frac{1}{2}\left(\max_{j}{\red{f_{j}}^{(0)}}+\min_{j}{\red{f_{j}}^{(0)}}\right)
\eeq
Parameters $v_0, \alpha_0$ and $\beta_0$ fixed so that the support of the distributions $\Nc(m_0, v_0)$ and $\Ic\Gc(\alpha_0, \beta_0)$ is sufficiently large for the considered volume
\item Prior on the projection : use a prior on the SNR : SNR=20 dB. Fix $\alphaez$ and
\beq
\betaez=\frac{\alphaez-1}{M}\times\|\bgb\|^{2}\times \frac{10^{-\frac{SNR}{10}}}{1+10^{-\frac{SNR}{10}}}.
\label{eq:betaez}
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Strategies to fix the parameters}
\begin{enumerate}
\item Potts coefficient is fixed empirically in order to have compact classes
\item A possible improvement would be to use an automatic and fast algorithm to fix this parameter at initialization
\begin{table}[htb]
\begin{center}
\begin{tabular}{|*{7}{c|}}
\hline
\textbf{Parameters} & $\alphaez$ & $K$ & $\gamma_{0}$ & $v_0$ & $\alpha_0$ & $\beta_0$ \\
\hline
Fixed values & 2.1 & 4 & 3 & 1 & 5 & 0.01 \\
\hline
\end{tabular}
\end{center}
\caption{Reconstruction parameters for 3D IQI data}
\label{tab:Reconstruction parameters}
\end{table}
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Reconstruction quality indicators}
\begin{enumerate}
\item The jointly retrieved reconstruction and segmentation can be used to quantify the quality of the reconstruction
\item A reconstruction is considered to be good if it has compact, quite homogeneous and distinguishable classes
\item We define reconstruction quality indicators which do not need reference.
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Compactness indicator for the reconstruction}
\begin{enumerate}
\item Quantify how compact the classes are :
\beq
C_{omp}=\frac{1}{K}\sum_{k=1}^{K}\frac{1}{\red{N_k}}\sum_{j \in \red{\Rc_k}}\frac{1}{N_{\Vc}}\sum_{i \in \Vc(j)} \delta(k-\red{z_i})
\label{eq:compacity at voxel's scale}
\eeq
where $N_{\Vc}$ is the number of neighbours : $N_{\Vc}=6$.
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Homogeneity indicator for the reconstruction}
\begin{enumerate}
\item Quantify how homogeneous the classes are
\beq
h_{omo}=\frac{1}{K}\sum_{k=1}^{K}\frac{1}{\red{N_k}}\sum_{j \in \red{\Rc_k}}(\hat{h}_{omo})_{j}
\eeq
with, if $\red{z_j}=k$ :
\beq
(\hat{h}_{omo})_{j}=
\frac{\sum_{i \in \Vc(j)}\exp\left(-(\red{f_j}-\red{f_i})^{2}\right)\delta(k-\red{z_i})}{\sum_{i \in \Vc(j)}\delta(k-\red{z_i})}
\eeq
if $\sum_{i \in \Vc(j)}\delta(k-\red{z_i}) \neq 0$. Otherwise, $(\hat{h}_{omo})_{j}=0$
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Distinguishability indicator for the reconstruction}
\begin{enumerate}
\item Quantify how distinguishable the classes are
\beq
d_{ist}=1-\frac{1}{K}\sum_{k=1}^{K}\frac{1}{\red{N_k}}\sum_{j \in \red{\Rc_k}}(\hat{d}_{ist})_{j}
\eeq
with, if $\red{z_j}=k$ :
\beq
(\hat{d}_{ist})_{j}=
\left\{
\barr{ll}
&\frac{\sum_{i \in \Vc(j)}\exp\left(-(\red{f_j}-\red{f_i})^{2}\right)(1-\delta(k-\red{z_i}))}{\sum_{i \in \Vc(j)}(1-\delta(k-\red{z_i}))} \mbox{~~if $j$ is on a~~} \\
&\mbox{~~\hspace*{43mm} contour~~} \\
&0 \mbox{~~otherwise~~}
\earr
\right.
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Comparison with other methods}
\begin{enumerate}
\item Comparison with FDK and Total Variation Minimization (TV)
\item In order to apply our reconstruction quality indicators, FDK and TV reconstructions are post-segmented using a Gauss-Markov-Potts prior model (same model as before excepted that $\Hb$ is replaced by $\Ib_N$)
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{}
\begin{block}{Results on real 3D data : Reconstructions (bottom and top)}
\begin{figure}
%FDK
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{volume_FDKProj300Bas.png}
\end{minipage} \hfill
%TV
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{volumeIQI_TVProj300Bas.png}
\end{minipage} \hfill
%JMAP
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{volumeIQI_JMAPPottsIndGamma3K4Proj300Bas.png}
\end{minipage} \vfill
%FDK
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{volume_FDKProj300Haut.png}
\caption*{FDK}
\end{minipage} \hfill
%TV
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{volumeIQI_TVProj300Haut.png}
\caption*{TV}
\end{minipage} \hfill
%JMAP
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{volumeIQI_JMAPPottsIndGamma3K4Proj300Haut.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{}
\begin{block}{Results on real 3D data : Segmentations (bottom and top)}
\begin{figure}
%FDK
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{segmentation_FDKK4Proj300Bas.png}
\end{minipage} \hfill
%TV
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{segmentationIQI_TVGamma3K4Proj300Bas.png}
\end{minipage} \hfill
%JMAP
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{segmentationIQI_JMAPPottsIndGamma3K4Proj300Bas.png}
\end{minipage} \vfill
%FDK
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{segmentation_FDKK4Proj300Haut.png}
\caption*{FDK}
\end{minipage} \hfill
%TV
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{segmentationIQI_TVGamma3K4Proj300Haut.png}
\caption*{TV}
\end{minipage} \hfill
%JMAP
\begin{minipage}[htb]{0.30\linewidth}
\centering
\includegraphics[scale=0.19]{segmentationIQI_JMAPPottsIndGamma3K4Proj300Haut.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Comparison with other methods}
\begin{enumerate}
\item JMAP algorithm retrieves the reconstruction with the best contrast
\item We compute the reconstruction quality indicators
\begin{table}[htb]
\begin{center}
\begin{tabular}{|*{4}{c|}}
\hline
\textbf{Indicator} & $C_{omp}$ & $d_{ist}$ & $h_{omo}$  \\
\hline
FDK & 94.4 \% & 78.4 \% & 78.3 \% \\
\hline
TV & \textbf{94.5} \% & 77.5 \% & 77.5 \% \\
\hline
JMAP & 94.3 \% & \textbf{79.0} \% & \textbf{78.8} \% \\
\hline
\end{tabular}
\end{center}
\label{tab:Comparison of FDK and JMAP using reconstruction quality indicators}
\end{table} 
\item JMAP algorithm retrieves the reconstruction with the most distinguishable and homogeneous classes
\item More discriminating reconstruction quality indicators shall be studied
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
% We compare the profile of the holes : best contrast for JMAP
\begin{block}{Measure the resolution : profiles of the holes}
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.30]{AnalyzeHolesVolIQI_FDKProj300.png}
\caption*{FDK}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.30]{AnalyzeHolesVolIQI_TVProj300.png}
\caption*{TV}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{TraceProfileHoleHorizontal.png}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.30]{AnalyzeHolesVolIQI_JMAPGamma3K4Proj300.png}
\caption*{JMAP}
\end{minipage}
\label{fig:Profiles of holes for FDK (a) and JMAP (b) reconstructions}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Measure the resolution : Peak height ratio}
\begin{minipage}[htb]{0.46\linewidth}
\begin{figure}
\centering
\includegraphics[scale=0.27]{PeakHeightRatio100pourcent.png}
\caption*{Diameter of the holes : 1.2 mm}
\end{figure}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{TraceProfileHole.png}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\begin{figure}
\centering
\includegraphics[scale=0.27]{PeakHeightRatio90pourcent.png}
\caption*{Diameter of the holes : 0.5 mm}
\end{figure}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\begin{enumerate}
\item Plot the profile for each pair of holes, with different diameters
\item Compute the peak height ratio : $r_h=\frac{h_{up}}{h_{down}}$
\end{enumerate}
\end{minipage}
\end{block}
\end{frame}

\begin{frame}{Results on real 3D data}
\begin{block}{Comparison of the peak height ratio}
% best resolution for JMAP
\begin{minipage}[htb]{\linewidth}
\centering
\includegraphics[scale=0.38]{PeakHeightRatio}
\end{minipage} \vfill
\begin{minipage}[htb]{\linewidth}
\begin{table}[htb]
\begin{center}
\begin{tabular}{|*{6}{c|}}
\hline
\textbf{Diameter (mm)} & $1.02$ & $1.0$ & $0.5$ & $0.4$ & $0.3$ \\
\hline
FDK & \textbf{100} \% & \textbf{100} \% & 82.6 \% & 73.3 \% & 50.0 \% \\
\hline
TV & \textbf{100} \% & \textbf{100} \% & 92.1 \% & 87.3 \% & 77.4 \% \\
\hline
JMAP & \textbf{100} \% & \textbf{100} \% & \textbf{100} \% & \textbf{90.2} \% & \textbf{81.0} \% \\
\hline
\end{tabular}
\end{center}
\caption{Comparison of $r_h$ for different pairs of holes}
\end{table} 
\end{minipage}
\end{block}
\end{frame}

\begin{frame}{Conclusion and prospects}
\begin{enumerate}
\item We proposed a highly-parallelizable joint reconstruction and segmentation algorithm which obtained good results for reconstructing industrial parts
\item The segmentation is used to provide an optimized regularization in order to estimate the volume 
\item The labels retrieved jointly with the reconstruction shall be useful for NDT
\item The retrieved reconstruction for 3D IQI data has been shown to have better contrast and resolution than FDK and TV reconstructions.
\item For the moment, the segmentation step is performed on CPU and takes about $75 \%$ of the total computation time. An implementation of this step on GPU would greatly speed up the algorithm 
\end{enumerate}
\end{frame}

\begin{frame}
\begin{center}
\Huge
\blue{Thanks for your attention !}
\end{center}
\end{frame}

\begin{frame}{Acknowledgements}
The authors are grateful to Lionel Gay and Nicolas Cochennec from Safran Composites for having provided the real IQI phantom used to test the method.
\end{frame}

\begin{frame}
\begin{center}
\Huge
\blue{Appendix}
\end{center}
\end{frame}

\begin{frame}{Joint Maximization a Posteriori (JMAP)}
% The estimation of the volume is done by optimizing a criterion which is built by using the estimates of the other unknowns and the segmentation from the previous iterations
\begin{block}{Estimation of the volume}
\begin{enumerate}
\item A criterion built by using the segmentation found during the previous iteration is optimized
\item Maximizing
\beq
p(\rfb|\rzb, \red{\vb_{\epsilon}}, \rmb, \rvb; \bgb, \Mc)
\propto p(\bgb|\rfb,\red{\vb_{\epsilon}})\, p(\rfb|\rzb,\rmb,\rvb)
\eeq
leads to minimize
\begin{align*}
J(\rfb)&=\|\bgb-\Hb\rfb\|_{\red{\Vb_{\epsilon}}}^{2}+\|\rfb-\rmb_{\rzb}\|_{\red{\Vb_{\zb}}}^{2} \\
&=\|\bgb-\Hb\rfb\|_{\red{\Vb_{\epsilon}}}^{2}+\sum_{j=1}^{N}\sum_{k=1}^{K}\frac{\left(\red{f_{j}}-\red{m_{k}}\right)^{2}}{\red{v_{k}}}\delta(\red{z_j}-k)
\end{align*}
\item Simple gradient descent with optimal step computing is performed
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Joint Maximization a Posteriori (JMAP)}
% ICM gives good results for estimating the labels with minimum computational cost in a highly-parallelizable way
\begin{block}{Estimation of the labels}
\bfig[h]
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.23]{BlancsNoirsAyasso}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\bcc
\begin{picture}(60,70)

  \put(30,50){\makebox(0,0){maximize $E(\rzb_{\red{N}}|\rfb, \rzb_{\red{B}}, \rmb, \rvb;\Mc)$}}
  
  \put(30,40){\vector(0,-1){10}}
  \put(30,20){\makebox(0,0){maximize $E(\rzb_{\red{B}}|\rfb, \rzb_{\red{N}}, \rmb, \rvb; \Mc)$}}
  \put(30, 10){\line(0, -1){10}}
  \put(30, 0){\line(-1, 0){90}}
  \put(-60, 0){\line(0, 1){70}}
  \put(-60, 70){\line(1, 0){90}}
  \put(30, 70){\vector(0, -1){10}}
   
 \end{picture}
\ecc
\end{minipage}
\efig\textit{Iterated Conditional Modes} (ICM) to maximize Potts energy
\begin{align*}
E(\rzb|\rfb,\rmb,\rvb;\Mc)&=\sum_{j=1}^{N}\left[\sum_{k=1}^{K}\left(
\alpha_k-\frac{\left(\red{f_{j}}-\red{m_{k}}\right)^{2}}{2 \red{v_{k}}}-\frac{1}{2}\ln{(\red{v_k})}\right)\delta(\red{z_j}-k)\right. \\
&\left.+\gamma_0\sum_{i\in\Vc(j)}\delta(\red{z_j}-\red{z_i})\right]
\end{align*}
\end{block}
\end{frame}

\begin{frame}{Joint Maximization a Posteriori (JMAP)}
% The estimations of the other unknowns are given by analytical formulas thanks to the use of conjugate priors
\begin{block}{Estimation of the other unknowns}
\begin{enumerate}
\item Conjugate priors give analytical formulas
\beq
\hat{\red{v}}_{\red{\epsilon_{i}}}=\frac{\betaez+\frac{1}{2}\left(\blue{g_{i}}-\lbrack\Hb\rfb\rbrack_{i}\right)^{2}}{\alphaez+\frac{3}{2}}, \forall i \in \left\{ 1, \dots, M \right\},
\eeq
\beq
\hat{\red{m}}_{\red{k}}=\frac{m_0+\frac{v_0}{\red{v_{k}}}\sum_{j \in \red{\Rc_{k}}}\red{f_{j}}}{1+\frac{\red{N_{k}}v_0}{\red{v_{k}}}}, \forall k \in \left\{ 1, \dots, K \right\}
\eeq
and
\beq
\hat{\red{v}}_{\red{k}}=\frac{\beta_0+\frac{1}{2}\sum_{j \in \red{\Rc_{k}}}\left(\red{f_{j}}-\red{m_{k}}\right)^{2}}{\alpha_0+\frac{\red{N_{k}}}{2}+1}, \forall k \in \left\{ 1, \dots, K \right\}
\eeq
where $\red{N_k}$ is the number of voxels in class $k$ $\red{\Rc_k}$.
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Strategies to fix the parameters}
\begin{block}{Fixing $\betaez$}
\begin{enumerate}
\item $p(\red{v_{\epsilon_{i}}}|\alphaez,\betaez)=\Ic\Gc(\red{v_{\epsilon_{i}}}|\alphaez,\betaez), \forall i$
\item $SNR=10\log\left(\frac{\|\red{\gb_{0}}\|^{2}}{\|\red{\epsilonb}\|^{2}}\right)$
\item Assumption : the noise $\epsilonb$ and the unnoisy projections $\gb_{0}$ are orthogonal :
\beq
\|\bgb\|^{2}=\|\red{\gb_{0}}\|^{2}+\|\red{\epsilonb}\|^{2}
\label{eq:Noise and unnoisy data orthogonal}
\eeq
\item So : 
\beq
SNR=10\log\left(\frac{\|\bgb\|^{2}}{\|\red{\epsilonb}\|^{2}}-1\right)
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Strategies to fix the parameters}
\begin{block}{Fixing $\betaez$}
\begin{enumerate}
\item Approximate $\|\epsilonb\|^{2}$ by its expectation :
\begin{align*}
\|\red{\epsilonb}\|^{2} &\approx \mathbb{E}\left(\red{\epsilonb}^{T}\red{\epsilonb}\right)
=\Tr{\mathbb{E}(\red{\epsilonb}\red{\epsilonb}^{T})}=\Tr{\mathbb{E}\left(\mathbb{E}\left(\red{\epsilonb}\red{\epsilonb}^{T}|\red{\Vb_{\epsilon}}\right)\right)} \\
&=\Tr{\mathbb{E}\left(\red{\Vb_{\epsilon}}\right)}=\mathbb{E}\left(\Tr{\red{\Vb_{\epsilon}}}\right)=\mathbb{E}\left(\sum_{i=1}^{M} \red{v_{\epsilon_{i}}}\right) \\
&=\sum_{i=1}^{M}\mathbb{E}\left(\red{v_{\epsilon_{i}}}\right)=M \times \frac{\betaez}{\left(\alphaez-1\right)}
\end{align*}
\item So :
\beq
\betaez=\frac{\alphaez-1}{M}\times\|\bgb\|^{2}\times \frac{10^{-\frac{SNR}{10}}}{1+10^{-\frac{SNR}{10}}}.
\label{eq:betaez appendix}
\eeq
\end{enumerate}
\end{block}
\end{frame}

\begin{frame}{Profiles of the holes for each pair of holes}
\begin{block}{Diameter : 1.2 mm}
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/FDK/300proj/ProfilTrousTaille1.png}
\caption*{FDK}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/TV/300proj/ProfilTrousTaille1.png}
\caption*{TV}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/JMAPMGINonSplitGamma3K4/300proj/ProfilTrousTaille1.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{Profiles of the holes for each pair of holes}
\begin{block}{Diameter : 1.0 mm}
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/FDK/300proj/ProfilTrousTaille2.png}
\caption*{FDK}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/TV/300proj/ProfilTrousTaille2.png}
\caption*{TV}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/JMAPMGINonSplitGamma3K4/300proj/ProfilTrousTaille2.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{Profiles of the holes for each pair of holes}
\begin{block}{Diameter : 0.5 mm}
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/FDK/300proj/ProfilTrousTaille3.png}
\caption*{FDK}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/TV/300proj/ProfilTrousTaille3.png}
\caption*{TV}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/JMAPMGINonSplitGamma3K4/300proj/ProfilTrousTaille3.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{Profiles of the holes for each pair of holes}
\begin{block}{Diameter : 0.4 mm}
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/FDK/300proj/ProfilTrousTaille4.png}
\caption*{FDK}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/TV/300proj/ProfilTrousTaille4.png}
\caption*{TV}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/JMAPMGINonSplitGamma3K4/300proj/ProfilTrousTaille4.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{Profiles of the holes for each pair of holes}
\begin{block}{Diameter : 0.3 mm}
\begin{figure}
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/FDK/300proj/ProfilTrousTaille5.png}
\caption*{FDK}
\end{minipage} \hfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/TV/300proj/ProfilTrousTaille5.png}
\caption*{TV}
\end{minipage} \vfill
\begin{minipage}[htb]{0.46\linewidth}
\centering
\includegraphics[scale=0.27]{ProfilsTrousIQICalculResolution/JMAPMGINonSplitGamma3K4/300proj/ProfilTrousTaille5.png}
\caption*{JMAP}
\end{minipage}
\end{figure}
\end{block}
\end{frame}

\begin{frame}{References}
\bibliographystyle{ieeetr}
\bibliography{ChapdelaineBibliographie}
\end{frame}

\end{document}